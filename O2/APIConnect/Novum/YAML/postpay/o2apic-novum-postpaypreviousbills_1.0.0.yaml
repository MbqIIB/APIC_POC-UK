---
swagger: "2.0"
info:
  x-ibm-name: "postpaypreviousbills"
  title: "O2APIC-Novum-PostPay/previousbills"
  version: "1.0.0"
schemes:
- "https"
host: "$(catalog.host)"
basePath: "/postpaypreviousbills"
consumes:
- "application/json"
produces:
- "application/json"
securityDefinitions:
  clientIdHeader:
    type: "apiKey"
    in: "header"
    name: "X-IBM-Client-Id"
security:
- clientIdHeader: []
x-ibm-configuration:
  testable: true
  enforced: true
  cors:
    enabled: true
  assembly:
    execute:
    - gatewayscript:
        title: "ConsolidatedAuthService : Invoke"
        version: "1.0.0"
        source: "/* ***********************************************************************************************************************\
          \ */\r\n/* ***********************************************************************************************************************\
          \ */\r\n/* FileName                                Version    Created By\
          \                  Modified By               Date           */\r\n/* ConsolidatedAuthServiceRequest.js\
          \       1.0        Abhinav Saxena                                      \
          \  08-May-2018    */\r\n/*                                             \
          \                                                                      \
          \      */\r\n/* ***********************************************************************************************************************\
          \ */\r\n/* Purpose: This GW Script file get and validate all the incoming\
          \ headers and set headers to call Auth Service             */\r\n/*    \
          \                                                                      \
          \                                               */\r\n/* Required params:\
          \                                                                      \
          \                                  */\r\n/* ***********************************************************************************************************************\
          \ */\r\n\r\n\r\napim.setvariable('message.headers.x-ibm-client-id','1e8584b2-3f03-4714-9812-f40ff4d94d81');\r\
          \n\r\n\r\n\r\n//get header paramerts from the incoming request\r\nvar authcode\
          \ = apim.getvariable('request.headers.x-authcode');\r\nvar msisdn = apim.getvariable('request.headers.msisdn');\r\
          \nvar device = apim.getvariable('request.headers.x-device');\r\nvar content\
          \ = apim.getvariable('request.headers.content-type');\r\nvar correlator\
          \ = apim.getvariable('request.headers.x-correlator');\r\n\r\nvar errorName\
          \ = undefined;\r\n\r\nif(authcode == null || authcode == undefined){\r\n\
          \    apim.setvariable('errorName', 'MissingAuthCode');\r\n    apim.error('MissingAuthCode',500,\
          \ 'Null Auth Code','Null Auth Code Received');\r\n    //errorName = \"MissingAuthCode\"\
          \r\n}\r\nelse if (msisdn == null || msisdn.length !== 12){\r\n    apim.setvariable('errorName',\
          \ 'InvalidMsisdn');\r\n    apim.error('InvalidMsisdn', 500 , 'Invalid MSISDN',\
          \ 'MSISDN Invalid or Null');\r\n    //errorName = \"InvalidMsisdn\"\r\n\
          }\r\nelse if (device == null || device == undefined || device.length ==\
          \ 0){\r\n    apim.setvariable('errorName', 'InvalidDeviceType');\r\n   \
          \ apim.error('InvalidDeviceType', 500 , 'Invalid Device', 'Device details\
          \ null');\r\n    //errorName = \"InvalidDeviceType\"\r\n}\r\nelse if (content\
          \ !== 'application/json'){\r\n    apim.setvariable('errorName', 'IncorrectContent');\r\
          \n    apim.error('IncorrectContent',500, 'Content Incorrect', 'Incorrect\
          \ Content');\r\n    //errorName = \"IncorrectContent\"\r\n}\r\nelse if (correlator\
          \ == null || correlator.length == 0){\r\n    apim.setvariable('errorName',\
          \ \"MissingCorrelator\");\r\n    apim.error('MissingCorrelator',500, 'Missing\
          \ Correlator' , 'Missing Correlator');\r\n    //errorName = \"MissingCorrelator\"\
          \r\n}\r\nelse {\r\n    apim.setvariable('message.headers.x-authcode' , authcode);\r\
          \n    apim.setvariable('message.headers.msisdn' , msisdn);\r\n    apim.setvariable('message.headers.x-device'\
          \ , device);\r\n    apim.setvariable('message.headers.content-type' , content);\r\
          \n    apim.setvariable('message.headers.x-callid' , correlator );\r\n}"
    - invoke:
        target-url: "https://api.eu.apiconnect.ibmcloud.com/dineshtomardt93gmailcom-dev/sb/apic/authservice/getconsolidatedauth"
        verb: "GET"
        title: "Invoke Consolidated Auth API"
        description: "Gets Disambiguation ID and Access Token"
        output: "getConsolidatedAuthResponseObj"
        stop-on-error: []
    - gatewayscript:
        title: "Create request for Phone Service"
        version: "1.0.0"
        source: "/* ***********************************************************************************************************************\
          \ */\r\n/* ***********************************************************************************************************************\
          \ */\r\n/* FileName                                Version    Created By\
          \                  Modified By               Date           */\r\n/* PhoneServiceRequest.js\
          \                   1.0       Abhinav Saxena                           \
          \             08-May-2018    */\r\n/*                                  \
          \                                                                      \
          \                 */\r\n/* ***********************************************************************************************************************\
          \ */\r\n/* Purpose: This GW Script file will create request for phone service.\
          \                                                     */\r\n/*         \
          \                                                                      \
          \                                          */\r\n/* Required params:   \
          \                                                                      \
          \                               */\r\n/* ***********************************************************************************************************************\
          \ */\r\n\r\nvar errorName = undefined;\r\n\r\n//Save the getConsolidatedAuth\
          \ call response body to a variable\r\nvar getConsolidatedAuthResponse =\
          \ apim.getvariable('getConsolidatedAuthResponseObj.body');\r\n\r\n//Check\
          \ if the consolidated auth response is empty\r\nif (getConsolidatedAuthResponse\
          \ == null || isJSONEmpty(getConsolidatedAuthResponse)){\r\n    apim.setvariable('errorName',\
          \ 'ConnectionError');\r\n    apim.error('ConnectionError',500,'Internal\
          \ Error','Connection Error Has Occured');\r\n}\r\nelse if (getConsolidatedAuthResponse.disambiguation_id\
          \ == null){\r\n    apim.setvariable('errorName', 'NullDisambiguationID');\r\
          \n    apim.error('NullDisambiguationID',500,'Internal Error','Disambiguation\
          \ ID is Null');\r\n    \r\n}\r\nelse if (getConsolidatedAuthResponse.access_token\
          \ == null){\r\n    apim.setvariable('errorName', 'NullAccessToken');\r\n\
          \    apim.error('NullAccessToken',500,'Internal Error','Access Token is\
          \ Null');\r\n    \r\n}\r\nelse {\r\n//Create request for phone details service\r\
          \nvar phoneDetailsRequestObj = {\r\n    \"disambiguation-id\": getConsolidatedAuthResponse.disambiguation_id,\r\
          \n    \"Authorization\": 'Bearer '+ getConsolidatedAuthResponse.access_token\r\
          \n};\r\n}\r\n\r\n//Set the message body\r\napim.setvariable('message.body',phoneDetailsRequestObj);\r\
          \n\r\n\r\nfunction isJSONEmpty(jsonObject) {\r\n    var member;\r\n    var\
          \ result = true;\r\n    for (member in jsonObject) {\r\n        if (jsonObject[member]\
          \ != null) {\r\n            result = false;\r\n        }\r\n    }\r\n  \
          \  return result;\r\n}"
    - invoke:
        title: "Invoke Phone Service"
        timeout: 60
        verb: "GET"
        cache-response: "protocol"
        cache-ttl: 900
        stop-on-error:
        - null
        version: "1.0.0"
        target-url: "http://demo5598884.mockable.io/phone/consumer/CURRENT/paym/bill/previousbills"
        output: "phoneServiceResponseObj"
    - gatewayscript:
        title: "Validate Phone Service Response"
        version: "1.0.0"
        source: "/* ***********************************************************************************************************************\
          \ */\r\n/* ***********************************************************************************************************************\
          \ */\r\n/* FileName                                Version    Created By\
          \                  Modified By               Date           */\r\n/* ValidatePhoneServiceResponse.js\
          \         1.0        Abhinav Saxena                                    \
          \    08-May-2018    */\r\n/*                                           \
          \                                                                      \
          \        */\r\n/* ***********************************************************************************************************************\
          \ */\r\n/* Purpose: This GW Script file will validate response object of\
          \ phone service.                                            */\r\n/*   \
          \                                                                      \
          \                                                */\r\n/* Required params:\
          \                                                                      \
          \                                  */\r\n/* ***********************************************************************************************************************\
          \ */\r\n\r\nvar errorName = undefined;\r\n\r\n//Save the getConsolidatedAuth\
          \ call response body to a variable\r\nvar getPhoneServiceResponse = apim.getvariable('phoneServiceResponseObj.body');\r\
          \n\r\n//Check the response object if it is empty\r\nif(getPhoneServiceResponse\
          \ == null || isJSONEmpty(getPhoneServiceResponse)){\r\n    apim.setvariable('errorName','ConnectionError'\
          \ );\r\n    apim.error('ConnectionError', 500 , 'Internal Error','Connection\
          \ Error Has Occured');\r\n    \r\n}\r\n\r\nfunction isJSONEmpty(jsonObject)\
          \ {\r\n    var member;\r\n    var result = true;\r\n    for (member in jsonObject)\
          \ {\r\n        if (jsonObject[member] != null) {\r\n            result =\
          \ false;\r\n        }\r\n    }\r\n    return result;\r\n}"
    - map:
        title: "map"
        inputs:
          input:
            schema:
              $ref: "#/definitions/Phone Service Out"
            variable: "phoneServiceResponseObj.body"
            content: "application/json"
        outputs:
          output:
            schema:
              $ref: "#/definitions/Previous Bill API Response"
            variable: "message.body"
            content: "application/json"
        actions:
        - create: "output.previousBills"
          foreach: "input.previousBills"
          from: "input.previousBills"
          actions:
          - set: "totalBillAmount"
            from: "totalBillAmount"
          - set: "billNumber"
            from: "billNumber"
          - set: "billDate"
            from: "billDate"
            value: "$(billDate).toLocaleString()"
        version: "1.0.0"
    catch:
    - errors:
      - "MissingAuthCode"
      - "InvalidMsisdn"
      - "InvalidDeviceType"
      - "IncorrectContent"
      - "MissingCorrelator"
      - "ConnectionError"
      - "NullDisambiguationID"
      - "NullAccessToken"
      execute:
      - gatewayscript:
          title: "Error Script"
          version: "1.0.0"
          source: "/* ***********************************************************************************************************************\
            \ */\n/* ***********************************************************************************************************************\
            \ */\n/* FileName                                Version    Created By\
            \                  Modified By               Date           */\n/* Errorhandling.js\
            \                        1.0        Dinesh Tomar                     \
            \                     07-May-2018    */\n/*                          \
            \                                                                    \
            \                           */\n/* ***********************************************************************************************************************\
            \ */\n/* Purpose: This GW Script file will read error config for the catch\
            \ block error name and will set the necessary params    */\n/*       \
            \   like status code, reason phrase and will return the error json   \
            \                                              */\n/* Required params:\
            \ errorName                                                          \
            \                                    */\n/* ***********************************************************************************************************************\
            \ */\nvar urlOpen = require('urlopen');\n//fetch errorName and errorConfig\
            \ JSON from context variables\nvar errorConfigURL = \"http://demo9811818.mockable.io/error-config\"\
            ;\nvar errorConfigURLOptions = {\n    target: errorConfigURL,\n    sslClientProfile:\
            \ ''\n};\nurlOpen.open(errorConfigURLOptions, function (error, response)\
            \ {\n    if (error) {\n        throw error;\n    } else {\n        response.readAsJSON(function\
            \ (error, errorConfigJSON) {\n            if (error) {\n             \
            \   throw error;\n            } else {\n                var errorName\
            \ = apim.getvariable('errorName');\n                if (errorName == null)\
            \ {\n                    errorName = 'default';\n                }\n \
            \               //fetch specific block from error config JSON\n      \
            \          if (! isJSONEmpty(errorConfigJSON)) {\n                   \
            \ var errorDetails = errorConfigJSON.errorConfig.errorTypes[errorName];\n\
            \                    var statusCode = errorDetails.statusCode;\n     \
            \               var reasonPhrase = errorDetails.reasonPhrase;\n      \
            \              var errorMessage = errorDetails.errorMessage;\n       \
            \             apim.setvariable('message.headers.content-type', 'application/json');\n\
            \                    apim.setvariable('message.status.code', statusCode);\n\
            \                    apim.setvariable('message.status.reason', reasonPhrase);\n\
            \                    apim.setvariable('message.body', errorMessage);\n\
            \                }\n                //else block executes in case error\
            \ config file is not loaded. it will set a default error message\n   \
            \             else {\n                    apim.setvariable('message.headers.content-type',\
            \ 'application/json');\n                    apim.setvariable('message.status.code',\
            \ 500);\n                    apim.setvariable('message.status.reason',\
            \ 'Internal Server Error');\n                    apim.setvariable('message.body',\
            \ {\n                        \"error\": \"Something went wrong\"\n   \
            \                 });\n                }\n            }\n        });\n\
            \    }\n});\n\n//below function checks if json object is null or not\n\
            function isJSONEmpty(jsonObject) {\n    var member;\n    var result =\
            \ true;\n    for (member in jsonObject) {\n        if (jsonObject[member]\
            \ != null) {\n            result = false;\n        }\n    }\n    return\
            \ result;\n}"
  phase: "realized"
paths:
  /previousBill:
    get:
      responses:
        200:
          description: "200 OK"
definitions:
  Auth Service Out:
    description: ""
    type: "object"
    properties:
      msisdn:
        type: "string"
      isPayg:
        type: "boolean"
      authCode:
        type: "string"
      access_token:
        type: "string"
      disambiguation_id:
        type: "string"
      transfer_auth_code:
        type: "string"
      ssoLink:
        type: "string"
    example: "{\r\n  \"msisdn\": \"7777777777\",\r\n  \"isPayg\": false,\r\n  \"authCode\"\
      : \"X-CodeHolder\",\r\n  \"access_token\": \"1e8584b2-3f03-4714-9812-f40ff4d94d81\"\
      ,\r\n  \"disambiguation_id\": \"92c44c9d-fcd5-4cf4-9f0e-c345e0a5e458\",\r\n\
      \  \"transfer_auth_code\": \"e7dd3004-4876-448f-b526-61c0db0b778d\",\r\n  \"\
      ssoLink\": \"https://identity.ref.o2.co.uk/redeem/tac?transfer_auth_code=e7dd3004-4876-448f-b526-61c0db0b778d&sendTo=https://billing.ref.o2.co.uk/bill?noheader=true&routeTo=pay/bill&disambiguation_id=92c44c9d-fcd5-4cf4-9f0e-c345e0a5e458&cm_mmc=myo2app-_-deviceInformationHolder-_-1e8584b2-3f03-4714-9812-f40ff4d94d81-_-bills-_-makeapayment&failureUrl=https://mymobile.ref.o2.co.uk/error/page/500?noheader=true&cm_mmc=myo2app-_-deviceInformationHolder-_-1e8584b2-3f03-4714-9812-f40ff4d94d81-_-bills-_-makeapayment\"\
      \r\n}\r\n"
  Phone Service Out:
    description: ""
    type: "object"
    properties:
      previousBills:
        type: "array"
        items:
          properties:
            totalBillAmount:
              type: "number"
            billNumber:
              type: "string"
            billDate:
              type: "string"
          type: "object"
    example: "{\r\n    \"previousBills\": [{\r\n        \"totalBillAmount\": 655.81,\r\
      \n        \"billNumber\": \"447000000009-07\",\r\n        \"billDate\": \"01.03.2013\"\
      \r\n    }, {\r\n        \"totalBillAmount\": 118.63,\r\n        \"billNumber\"\
      : \"447000000009-06\",\r\n        \"billDate\": \"01.02.2013\"\r\n    }, {\r\
      \n        \"totalBillAmount\": 56.63,\r\n        \"billNumber\": \"447000000009-05\"\
      ,\r\n        \"billDate\": \"01.01.2013\"\r\n    }, {\r\n        \"totalBillAmount\"\
      : 43.63,\r\n        \"billNumber\": \"447000000009-04\",\r\n        \"billDate\"\
      : \"01.12.2012\"\r\n    }, {\r\n        \"totalBillAmount\": 21.63,\r\n    \
      \    \"billNumber\": \"447000000009-03\",\r\n        \"billDate\": \"01.11.2012\"\
      \r\n    }, {\r\n        \"totalBillAmount\": -1.63,\r\n        \"billNumber\"\
      : \"447000000009-02\",\r\n        \"billDate\": \"01.10.2012\"\r\n    }]\r\n\
      }"
  Previous Bill API Response:
    description: ""
    type: "object"
    properties:
      previousBills:
        type: "array"
        items:
          properties:
            totalBillAmount:
              type: "number"
            billNumber:
              type: "string"
            billDate:
              type: "string"
          type: "object"
    example: "{\r\n  \"previousBills\": [\r\n    {\r\n      \"totalBillAmount\": 0,\r\
      \n      \"billNumber\": \"string\",\r\n      \"billDate\": \"2018-05-17T04:46:23.890Z\"\
      \r\n    }\r\n  ]\r\n}"
  Phone Service In:
    description: ""
    type: "object"
    properties:
      disambiguation-id:
        type: "string"
      Authorization:
        type: "string"
    example: "{\n        \"disambiguation-id\" : \"7cf0e8f0-8dda-4599-97c9-d3ec51dd60c7\"\
      ,\n    \"Authorization\" : \"Bearer cf1c70d3-2e1d-4fa7-af73-6f4eda0ce104\"\n\
      }"
  PreviousBillSummary:
    type: "object"
    properties:
      totalBillAmount:
        type: "number"
      billNumber:
        type: "string"
      billDate:
        type: "string"
        format: "date-time"
tags: []
