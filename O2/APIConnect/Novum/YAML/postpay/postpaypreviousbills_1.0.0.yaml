---
swagger: "2.0"
info:
  x-ibm-name: "postpaypreviousbills"
  title: "O2APIC-Novum-PostPay/previousbills"
  version: "1.0.0"
schemes:
- "https"
host: "$(catalog.host)"
basePath: "/postpaypreviousbills"
consumes:
- "application/json"
produces:
- "application/json"
securityDefinitions:
  clientIdHeader:
    type: "apiKey"
    in: "header"
    name: "X-IBM-Client-Id"
security:
- clientIdHeader: []
x-ibm-configuration:
  testable: true
  enforced: true
  cors:
    enabled: true
  assembly:
    execute:
    - gatewayscript:
        title: "Form Property Invoke URL"
        version: "1.0.0"
        source: "/* ***********************************************************************************************************************\
          \ */\n/* ***********************************************************************************************************************\
          \ */\n/* FileName                                Version    Created By \
          \                 Modified By               Date           */\n/* FormPropertyInvokeURL.js\
          \                1.0        Abhinav Saxena                             \
          \           25-May-2018    */\n/*                                      \
          \                                                                      \
          \             */\n/* ***********************************************************************************************************************\
          \ */\n/* Purpose: This GW Script file will for the URL to invoke Property\
          \ API                                                    */\n/*        \
          \                                                                      \
          \                                           */\n/* Required params:    \
          \                                                                      \
          \                              */\n/* ***********************************************************************************************************************\
          \ */\n\n    var clientId = apim.getvariable('client.app.id');\n    apim.setvariable('message.headers.x-ibm-client-id',\
          \ clientId);\n    apim.setvariable('message.headers.content-type', 'application/json');\n\
          \    //form url for to fetch errorConfig JSON\n    var hostName = apim.getvariable('api.endpoint.hostname');\n\
          \    var orgName = apim.getvariable('api.org.name');\n    var catalog =\
          \ apim.getvariable('env.path');\n    var configPropertiesURL = 'https://'+hostName+'/'+orgName+'/'+catalog+'/'+'config/properties';\n\
          \    apim.setvariable('configPropertiesURL', configPropertiesURL);"
    - invoke:
        title: "Invoke:PropertiesHandler"
        timeout: 60
        verb: "GET"
        cache-response: "protocol"
        cache-ttl: 900
        stop-on-error:
        - null
        version: "1.0.0"
        target-url: "$(configPropertiesURL)"
        output: "messages-property"
    - gatewayscript:
        title: "ConsolidatedAuthService : Invoke"
        version: "1.0.0"
        source: "/* ***********************************************************************************************************************\
          \ */\n/* ***********************************************************************************************************************\
          \ */\n/* FileName                                Version    Created By \
          \                 Modified By               Date           */\n/* ConsolidatedAuthServiceRequest.js\
          \       1.0        Abhinav Saxena                                      \
          \  08-May-2018    */\n/*                                               \
          \                                                                      \
          \    */\n/* ***********************************************************************************************************************\
          \ */\n/* Purpose: This GW Script file get and validate all the incoming\
          \ headers and set headers to call Auth Service             */\n/*      \
          \                                                                      \
          \                                             */\n/* Required params:  \
          \                                                                      \
          \                                */\n/* ***********************************************************************************************************************\
          \ */\nvar messages = apim.getvariable('messages-property.body');\n\napim.setvariable('message.headers.x-ibm-client-id','1e8584b2-3f03-4714-9812-f40ff4d94d81');\n\
          \n\n\n//get header paramerts from the incoming request\nvar authcode = apim.getvariable('request.headers.x-authcode');\n\
          var msisdn = apim.getvariable('request.parameters.msisdn');\nvar device\
          \ = apim.getvariable('request.headers.x-device');\nvar content = apim.getvariable('request.headers.content-type');\n\
          var correlator = apim.getvariable('request.headers.x-correlator');\n\nvar\
          \ errorName = undefined;\n\nif(authcode == null || authcode == undefined\
          \ || authcode.length == 0){\n    apim.setvariable('errorName', 'InvalidAuthCode');\n\
          \    apim.error('InvalidAuthCode',500, 'Null Auth Code','Null Auth Code\
          \ Received');\n    //errorName = \"MissingAuthCode\"\n}\nelse if (msisdn\
          \ == null || msisdn.length !== 12 || msisdn == undefined){\n    apim.setvariable('errorName',\
          \ 'InvalidMsisdn');\n    apim.error('InvalidMsisdn', 500 , 'Invalid MSISDN',\
          \ 'MSISDN Invalid or Null');\n    //errorName = \"InvalidMsisdn\"\n}\nelse\
          \ if (device == null || device == undefined || device.length == 0){\n  \
          \  apim.setvariable('errorName', 'InvalidDeviceType');\n    apim.error('InvalidDeviceType',\
          \ 500 , 'Invalid Device', 'Device details null');\n    //errorName = \"\
          InvalidDeviceType\"\n}\nelse if (content == null || content !== 'application/json'){\n\
          \    apim.setvariable('errorName', 'IncorrectContent');\n    apim.error('IncorrectContent',500,\
          \ 'Content Incorrect', 'Incorrect Content');\n    //errorName = \"IncorrectContent\"\
          \n}\nelse if (correlator == null || correlator == undefined || correlator.length\
          \ == 0 ){\n    apim.setvariable('errorName', \"InvalidCorrelator\");\n \
          \   apim.error('InvalidCorrelator',500, 'Missing Correlator' , 'Missing\
          \ Correlator');\n    //errorName = \"MissingCorrelator\"\n}\nelse if (messages\
          \ == null || isJSONEmpty(messages)){\n    apim.setvariable('errorName',\
          \ 'ConnectionError');\n    apim.error('ConnectionError', 500, 'Internal\
          \ Error', 'Connection error');\n}\nelse {\n    apim.setvariable('authCodeEndPoint',\
          \ messages.authserver.generateTransferAuthCode.apicURI);\n    apim.setvariable('message.headers.x-authcode'\
          \ , authcode);\n    apim.setvariable('message.headers.msisdn' , msisdn);\n\
          \    apim.setvariable('message.headers.x-device' , device);\n    apim.setvariable('message.headers.content-type'\
          \ , content);\n    apim.setvariable('message.headers.x-callid' , correlator\
          \ );\n}\n\nfunction isJSONEmpty(jsonObject) {\n    var member;\n    var\
          \ result = true;\n    for (member in jsonObject) {\n        if (jsonObject[member]\
          \ != null) {\n            result = false;\n        }\n    }\n    return\
          \ result;\n}"
    - invoke:
        target-url: "$(authCodeEndPoint)"
        verb: "GET"
        title: "Invoke Consolidated Auth API"
        description: "Gets Disambiguation ID and Access Token"
        output: "getConsolidatedAuthResponseObj"
        stop-on-error: []
    - gatewayscript:
        title: "Create request for Phone Service"
        version: "1.0.0"
        source: "/* ***********************************************************************************************************************\
          \ */\n/* ***********************************************************************************************************************\
          \ */\n/* FileName                                Version    Created By \
          \                 Modified By               Date           */\n/* PhoneServiceRequest.js\
          \                   1.0       Abhinav Saxena                           \
          \             08-May-2018    */\n/*                                    \
          \                                                                      \
          \               */\n/* ***********************************************************************************************************************\
          \ */\n/* Purpose: This GW Script file will create request for phone service.\
          \                                                     */\n/*           \
          \                                                                      \
          \                                        */\n/* Required params:       \
          \                                                                      \
          \                           */\n/* ***********************************************************************************************************************\
          \ */\n\n//Save the getConsolidatedAuth call response body to a variable\n\
          var getConsolidatedAuthResponse = apim.getvariable('getConsolidatedAuthResponseObj.body');\n\
          var msisdn = apim.getvariable('request.parameters.msisdn');\nvar messages\
          \ = apim.getvariable('messages-property.body');\n\nvar url = messages.phoneservice.previousbills.uri;\n\
          //apim.setvariable('authCodeEndPoint', messages.authserver.generateTransferAuthCode.apicURI);\n\
          //apim.setvariable('url',phoneURL);\n//var url = \"http://demo5598884.mockable.io/phoneservice/consumer/CURRENT/paym/bill/previousbills\"\
          \n\nvar URI = url.replace(\"CURRENT\", msisdn);\n\n//Set the incoming MSISDN\
          \ value in the phone service URI part.\napim.setvariable('phoneServiceEndpoint',URI);\n\
          //apim.setvariable('phoneServiceEndpoint', messages.phoneservice.previousbills.uri);\n\
          //apim.setvariable('phoneURL2',\"http://demo5598884.mockable.io/phoneservice/consumer/\"\
          +msisdn+\"/paym/bill/previousbills\");\nvar errorName = undefined;\n\n//Check\
          \ if the consolidated auth response is empty\nif (getConsolidatedAuthResponse\
          \ == null || isJSONEmpty(getConsolidatedAuthResponse)){\n    apim.setvariable('errorName','ConnectionError');\n\
          \    apim.error('ConnectionError',500,'Internal Error','Connection Error\
          \ Has Occured');\n}\nelse if (getConsolidatedAuthResponse.disambiguation_id\
          \ == null){\n    apim.setvariable('errorName','InvalidDisambiguationID');\n\
          \    apim.error('InvalidDisambiguationID',500,'Internal Error','Disambiguation\
          \ ID is Null');\n}\nelse if (getConsolidatedAuthResponse.access_token ==\
          \ null){\n    apim.setvariable('errorName','InvalidAccessToken');\n    apim.error('InvalidAccessToken',500,'Internal\
          \ Error','Access Token is Null');\n}\nelse {\n//Create request for phone\
          \ details service\nvar phoneDetailsRequestObj = {\n    \"disambiguation-id\"\
          : getConsolidatedAuthResponse.disambiguation_id,\n    \"Authorization\"\
          : 'Bearer '+ getConsolidatedAuthResponse.access_token\n};\n}\n\n//Set the\
          \ message body\napim.setvariable('message.body',phoneDetailsRequestObj);\n\
          \n\nfunction isJSONEmpty(jsonObject) {\n    var member;\n    var result\
          \ = true;\n    for (member in jsonObject) {\n        if (jsonObject[member]\
          \ != null) {\n            result = false;\n        }\n    }\n    return\
          \ result;\n}"
    - invoke:
        title: "Invoke Phone Service"
        timeout: 60
        verb: "GET"
        cache-response: "protocol"
        cache-ttl: 900
        stop-on-error:
        - null
        version: "1.0.0"
        target-url: "$(phoneServiceEndpoint)"
        output: "phoneServiceResponseObj"
    - gatewayscript:
        title: "Validate Phone Service Response"
        version: "1.0.0"
        source: "/* ***********************************************************************************************************************\
          \ */\r\n/* ***********************************************************************************************************************\
          \ */\r\n/* FileName                                Version    Created By\
          \                  Modified By               Date           */\r\n/* ValidatePhoneServiceResponse.js\
          \         1.0        Abhinav Saxena                                    \
          \    08-May-2018    */\r\n/*                                           \
          \                                                                      \
          \        */\r\n/* ***********************************************************************************************************************\
          \ */\r\n/* Purpose: This GW Script file will validate response object of\
          \ phone service.                                            */\r\n/*   \
          \                                                                      \
          \                                                */\r\n/* Required params:\
          \                                                                      \
          \                                  */\r\n/* ***********************************************************************************************************************\
          \ */\r\n\r\nvar errorName = undefined;\r\n\r\n//Save the getConsolidatedAuth\
          \ call response body to a variable\r\nvar getPhoneServiceResponse = apim.getvariable('phoneServiceResponseObj.body');\r\
          \n\r\n//Check the response object if it is empty\r\nif(getPhoneServiceResponse\
          \ == null || isJSONEmpty(getPhoneServiceResponse)){\r\n    apim.setvariable('errorName','ConnectionError'\
          \ );\r\n    apim.error('ConnectionError', 500 , 'Internal Error','Connection\
          \ Error Has Occured');\r\n    \r\n}\r\n\r\nfunction isJSONEmpty(jsonObject)\
          \ {\r\n    var member;\r\n    var result = true;\r\n    for (member in jsonObject)\
          \ {\r\n        if (jsonObject[member] != null) {\r\n            result =\
          \ false;\r\n        }\r\n    }\r\n    return result;\r\n}"
    - map:
        title: "map"
        inputs:
          input:
            schema:
              $ref: "#/definitions/Phone Service Out"
            variable: "phoneServiceResponseObj.body"
            content: "application/json"
        outputs:
          output:
            schema:
              $ref: "#/definitions/Previous Bill API Response"
            variable: "message.body"
            content: "application/json"
        actions:
        - create: "output.previousBills"
          foreach: "input.previousBills"
          from: "input.previousBills"
          actions:
          - set: "totalBillAmount"
            from: "totalBillAmount"
          - set: "billNumber"
            from: "billNumber"
          - set: "billDate"
            from: "billDate"
            value: "$(billDate).toLocaleString()"
        version: "1.0.0"
    catch:
    - errors:
      - "ConnectionError"
      - "InvalidMsisdn"
      - "InvalidDeviceType"
      - "IncorrectContent"
      - "InvalidAuthCode"
      - "InvalidDisambiguationID"
      - "InvalidAccessToken"
      - "InvalidCorrelator"
      execute:
      - gatewayscript:
          title: "Error Script"
          version: "1.0.0"
          source: "/* ***********************************************************************************************************************\
            \ */\n/* ***********************************************************************************************************************\
            \ */\n/* FileName                                Version    Created By\
            \                  Modified By               Date           */\n/* Errorhandling.js\
            \                        1.0        Dinesh Tomar                     \
            \                     07-May-2018    */\n/*                          \
            \                                                                    \
            \                           */\n/* ***********************************************************************************************************************\
            \ */\n/* Purpose: This GW Script file will read error config for the catch\
            \ block error name and will set the necessary params    */\n/*       \
            \   like status code, reason phrase and will return the error json   \
            \                                              */\n/* Required params:\
            \ errorName                                                          \
            \                                    */\n/* ***********************************************************************************************************************\
            \ */\nvar urlOpen = require('urlopen');\n//form url for to fetch errorConfig\
            \ JSON\nvar hostName = apim.getvariable('api.endpoint.hostname');\nvar\
            \ orgName = apim.getvariable('api.org.name');\nvar catalog = apim.getvariable('env.path');\n\
            var errorConfigURL = 'https://'+hostName+'/'+orgName+'/'+catalog+'/'+'config/errorconfig';\n\
            var clientId = apim.getvariable('client.app.id');\nvar errorConfigURLOptions\
            \ = {\n    target: errorConfigURL,\n    sslClientProfile: 'api-sslcli-all',\n\
            \    headers: {'x-ibm-client-id': clientId, 'content-type': 'application/json'\
            \ }\n};\n//fetch errorName and errorConfig JSON from context variables\n\
            urlOpen.open(errorConfigURLOptions, function (error, response) {\n   \
            \ if (error) {\n        throw error;\n    } else {\n        response.readAsJSON(function\
            \ (error, errorConfigJSON) {\n            if (error) {\n             \
            \   throw error;\n            } else {\n                var errorName\
            \ = apim.getvariable('errorName');\n                if (errorName == null\
            \ && apim.getvariable('message.status.code') == null) {\n            \
            \        errorName = 'default';\n                } else if (errorName\
            \ == null && apim.getvariable('message.status.reason') != null && apim.getvariable('message.status.reason').startsWith('APIC:')\
            \ ) {\n                    errorName = 'default';\n                  \
            \  apim.setvariable('message.status.code', apim.getvariable('message.status.code'));\n\
            \                    apim.setvariable('message.status.reason', apim.getvariable('message.status.reason'));\n\
            \                    apim.setvariable('message.body', apim.getvariable('message.body'));\n\
            \                } else {\n                    //fetch specific block\
            \ from error config JSON\n                    if (! isJSONEmpty(errorConfigJSON))\
            \ {\n                        var errorDetails = errorConfigJSON.errorConfig.errorTypes[errorName];\n\
            \                        var statusCode = errorDetails.statusCode;\n \
            \                       var reasonPhrase = errorDetails.reasonPhrase;\n\
            \                        var errorMessage = errorDetails.errorMessage;\n\
            \                        apim.setvariable('message.headers.content-type',\
            \ 'application/json');\n                        apim.setvariable('message.status.code',\
            \ statusCode);\n                        apim.setvariable('message.status.reason',\
            \ reasonPhrase);\n                        apim.setvariable('message.body',\
            \ errorMessage);\n                    }\n                    //else block\
            \ executes in case error config file is not loaded. it will set a default\
            \ error message\n                    else {\n                        apim.setvariable('message.headers.content-type',\
            \ 'application/json');\n                        apim.setvariable('message.status.code',\
            \ 500);\n                        apim.setvariable('message.status.reason',\
            \ 'Internal Server Error');\n                        apim.setvariable('message.body',\
            \ {\n                            \"error\": \"Something went wrong\"\n\
            \                        });\n                    }\n                }\n\
            \            }\n        });\n    }\n});\n\n//below function checks if\
            \ json object is null or not\nfunction isJSONEmpty(jsonObject) {\n   \
            \ var member;\n    var result = true;\n    for (member in jsonObject)\
            \ {\n        if (jsonObject[member] != null) {\n            result = false;\n\
            \        }\n    }\n    return result;\n}"
  phase: "realized"
  properties:
    phoneURL:
      value: "http://demo5598884.mockable.io/phoneservice/consumer/CURRENT/paym/bill/previousbills"
      description: ""
      encoded: false
paths:
  /{msisdn}/postpay/bill/previousbills:
    get:
      responses:
        200:
          description: "200 OK"
    parameters:
    - name: "msisdn"
      type: "string"
      required: true
      in: "path"
    - name: "x-authcode"
      type: "string"
      required: true
      in: "header"
definitions:
  Auth Service Out:
    description: ""
    type: "object"
    properties:
      msisdn:
        type: "string"
      isPayg:
        type: "boolean"
      authCode:
        type: "string"
      access_token:
        type: "string"
      disambiguation_id:
        type: "string"
      transfer_auth_code:
        type: "string"
      ssoLink:
        type: "string"
    example: "{\r\n  \"msisdn\": \"7777777777\",\r\n  \"isPayg\": false,\r\n  \"authCode\"\
      : \"X-CodeHolder\",\r\n  \"access_token\": \"1e8584b2-3f03-4714-9812-f40ff4d94d81\"\
      ,\r\n  \"disambiguation_id\": \"92c44c9d-fcd5-4cf4-9f0e-c345e0a5e458\",\r\n\
      \  \"transfer_auth_code\": \"e7dd3004-4876-448f-b526-61c0db0b778d\",\r\n  \"\
      ssoLink\": \"https://identity.ref.o2.co.uk/redeem/tac?transfer_auth_code=e7dd3004-4876-448f-b526-61c0db0b778d&sendTo=https://billing.ref.o2.co.uk/bill?noheader=true&routeTo=pay/bill&disambiguation_id=92c44c9d-fcd5-4cf4-9f0e-c345e0a5e458&cm_mmc=myo2app-_-deviceInformationHolder-_-1e8584b2-3f03-4714-9812-f40ff4d94d81-_-bills-_-makeapayment&failureUrl=https://mymobile.ref.o2.co.uk/error/page/500?noheader=true&cm_mmc=myo2app-_-deviceInformationHolder-_-1e8584b2-3f03-4714-9812-f40ff4d94d81-_-bills-_-makeapayment\"\
      \r\n}\r\n"
  Phone Service Out:
    description: ""
    type: "object"
    properties:
      previousBills:
        type: "array"
        items:
          properties:
            totalBillAmount:
              type: "number"
            billNumber:
              type: "string"
            billDate:
              type: "string"
          type: "object"
    example: "{\r\n    \"previousBills\": [{\r\n        \"totalBillAmount\": 655.81,\r\
      \n        \"billNumber\": \"447000000009-07\",\r\n        \"billDate\": \"01.03.2013\"\
      \r\n    }, {\r\n        \"totalBillAmount\": 118.63,\r\n        \"billNumber\"\
      : \"447000000009-06\",\r\n        \"billDate\": \"01.02.2013\"\r\n    }, {\r\
      \n        \"totalBillAmount\": 56.63,\r\n        \"billNumber\": \"447000000009-05\"\
      ,\r\n        \"billDate\": \"01.01.2013\"\r\n    }, {\r\n        \"totalBillAmount\"\
      : 43.63,\r\n        \"billNumber\": \"447000000009-04\",\r\n        \"billDate\"\
      : \"01.12.2012\"\r\n    }, {\r\n        \"totalBillAmount\": 21.63,\r\n    \
      \    \"billNumber\": \"447000000009-03\",\r\n        \"billDate\": \"01.11.2012\"\
      \r\n    }, {\r\n        \"totalBillAmount\": -1.63,\r\n        \"billNumber\"\
      : \"447000000009-02\",\r\n        \"billDate\": \"01.10.2012\"\r\n    }]\r\n\
      }"
  Previous Bill API Response:
    description: ""
    type: "object"
    properties:
      previousBills:
        type: "array"
        items:
          properties:
            totalBillAmount:
              type: "number"
            billNumber:
              type: "string"
            billDate:
              type: "string"
          type: "object"
    example: "{\r\n  \"previousBills\": [\r\n    {\r\n      \"totalBillAmount\": 0,\r\
      \n      \"billNumber\": \"string\",\r\n      \"billDate\": \"2018-05-17T04:46:23.890Z\"\
      \r\n    }\r\n  ]\r\n}"
  Phone Service In:
    description: ""
    type: "object"
    properties:
      disambiguation-id:
        type: "string"
      Authorization:
        type: "string"
    example: "{\n        \"disambiguation-id\" : \"7cf0e8f0-8dda-4599-97c9-d3ec51dd60c7\"\
      ,\n    \"Authorization\" : \"Bearer cf1c70d3-2e1d-4fa7-af73-6f4eda0ce104\"\n\
      }"
  PreviousBillSummary:
    type: "object"
    properties:
      totalBillAmount:
        type: "number"
      billNumber:
        type: "string"
      billDate:
        type: "string"
        format: "date-time"
tags: []
